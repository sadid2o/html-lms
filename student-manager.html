<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Manager â€” Eduvance</title>
    <meta name="description" content="Manage students in Eduvance LMS">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading students...</div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="admin-layout">
        <!-- Sidebar Toggle (Mobile) -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="bi bi-list"></i>
        </button>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-icon">
                    <i class="bi bi-mortarboard-fill"></i>
                </div>
                <span class="brand-text">Eduvance</span>
                <button class="sidebar-close-btn" id="sidebarCloseBtn" title="Collapse sidebar">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="bi bi-grid-1x2-fill"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="course-editor.html" class="nav-link">
                        <i class="bi bi-plus-circle"></i>
                        <span>Create Course</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="category-manager.html" class="nav-link">
                        <i class="bi bi-tags"></i>
                        <span>Categories</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="student-manager.html" class="nav-link active">
                        <i class="bi bi-people-fill"></i>
                        <span>Students</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="announcements.html" class="nav-link">
                        <i class="bi bi-megaphone-fill"></i>
                        <span>Announcements</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="hf-settings.html" class="nav-link">
                        <i class="bi bi-gear"></i>
                        <span>Settings</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="nav-item">
                    <a href="#" class="nav-link" id="logoutBtn">
                        <i class="bi bi-box-arrow-left"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Header -->
            <header class="top-header">
                <div class="page-title">
                    <span>Student</span> Manager
                </div>
                <div class="admin-info">
                    <span class="text-secondary" style="font-size:0.85rem;" id="adminEmail"></span>
                    <div class="admin-avatar">
                        <i class="bi bi-person-fill"></i>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content">
                <!-- Search and Actions Bar -->
                <div class="content-card mb-4 animate-fade-in-up delay-1">
                    <div class="content-card-body" style="padding:16px 24px;">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-6">
                                <div class="search-box">
                                    <i class="bi bi-search search-icon"></i>
                                    <input type="text" class="form-custom" style="padding-left:40px;"
                                        placeholder="Search by name or email..." id="searchInput">
                                </div>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <button class="btn-gradient" onclick="exportToCSV()">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Students Table -->
                <div class="content-card animate-fade-in-up delay-2">
                    <div class="content-card-header">
                        <h5><i class="bi bi-people-fill me-2" style="color:var(--primary-light)"></i>All Students</h5>
                        <span class="badge-custom primary" id="studentCount">0</span>
                    </div>
                    <div class="content-card-body p-0">
                        <div class="table-responsive">
                            <table class="table-custom">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Signup Date</th>
                                        <th>Enrollments</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center py-5">
                                            <div class="loading-spinner mx-auto mb-2" style="width:32px;height:32px;">
                                            </div>
                                            Loading students...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Student Detail Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title"><i class="bi bi-person-circle"></i> Student Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Name</label>
                            <div class="fw-bold" id="modalName">-</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Email</label>
                            <div class="fw-bold" id="modalEmail">-</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Signup Date</label>
                            <div class="fw-bold" id="modalSignup">-</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Account Status</label>
                            <div class="fw-bold" id="modalStatus">-</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary small">Total Enrollments</label>
                            <div class="fw-bold" id="modalEnrollments">-</div>
                        </div>
                        <div class="col-12">
                            <label class="form-label text-secondary small">Enrolled Courses</label>
                            <div id="modalCourses">Loading...</div>
                        </div>
                        <div class="col-12">
                            <hr class="border-secondary">
                            <label class="form-label text-secondary small">Account Management</label>
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-sm btn-warning" onclick="toggleStudentStatus()"
                                    id="toggleStatusBtn">
                                    <i class="bi bi-pause-circle"></i> Deactivate Account
                                </button>
                                <button class="btn btn-sm btn-info" onclick="resetStudentPassword()">
                                    <i class="bi bi-key"></i> Reset Password
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStudent()">
                                    <i class="bi bi-trash"></i> Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let allStudents = [];
        let allEnrollments = [];
        let allCourses = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!Auth.requireAuth()) return;
            const admin = Auth.getAdmin();
            if (admin) document.getElementById('adminEmail').textContent = admin.email;
            setupSidebar();
            await loadData();
        });

        async function loadData() {
            try {
                // Load all data in parallel
                [allStudents, allEnrollments, allCourses] = await Promise.all([
                    FirestoreDB.getAllStudents(),
                    FirestoreDB.getAllEnrollments(),
                    FirestoreDB.getAllCourses()
                ]);

                renderStudents(allStudents);
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (e) {
                console.error(e);
                showToast('Failed to load data', 'error');
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function renderStudents(students) {
            const tbody = document.getElementById('studentsTableBody');
            document.getElementById('studentCount').textContent = students.length;

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5 text-muted">No students found</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => {
                const enrollmentCount = allEnrollments.filter(e => e.userId === student.id).length;
                const signupDate = student.createdAt?.toDate ? student.createdAt.toDate().toLocaleDateString() : '-';

                return `
                <tr>
                    <td data-label="Name"><i class="bi bi-person-circle me-2 text-primary"></i><strong>${esc(student.name || 'N/A')}</strong></td>
                    <td data-label="Email">${esc(student.email || 'N/A')}</td>
                    <td data-label="Signup Date"><span class="badge-custom primary">${signupDate}</span></td>
                    <td data-label="Enrollments"><span class="badge-custom info">${enrollmentCount}</span></td>
                    <td data-label="Actions">
                        <button class="btn-action" onclick="viewStudent('${student.id}')" title="View Details">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        let currentStudentId = null;

        async function viewStudent(studentId) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;

            currentStudentId = studentId;
            const studentEnrollments = allEnrollments.filter(e => e.userId === studentId);
            const enrolledCourseIds = studentEnrollments.map(e => e.courseId);
            const enrolledCourses = allCourses.filter(c => enrolledCourseIds.includes(c.id));

            document.getElementById('modalName').textContent = student.name || 'N/A';
            document.getElementById('modalEmail').textContent = student.email || 'N/A';
            document.getElementById('modalSignup').textContent = student.createdAt?.toDate ? student.createdAt.toDate().toLocaleDateString() : '-';
            document.getElementById('modalEnrollments').textContent = studentEnrollments.length;

            // Show account status
            const isActive = student.active !== false;
            const statusHtml = isActive
                ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>'
                : '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Deactivated</span>';
            document.getElementById('modalStatus').innerHTML = statusHtml;

            // Update toggle button
            const toggleBtn = document.getElementById('toggleStatusBtn');
            if (isActive) {
                toggleBtn.innerHTML = '<i class="bi bi-pause-circle"></i> Deactivate Account';
                toggleBtn.className = 'btn btn-sm btn-warning';
            } else {
                toggleBtn.innerHTML = '<i class="bi bi-play-circle"></i> Activate Account';
                toggleBtn.className = 'btn btn-sm btn-success';
            }

            const coursesHtml = enrolledCourses.length > 0
                ? enrolledCourses.map(c => `<div class="badge bg-secondary me-2 mb-2">${esc(c.name)}</div>`).join('')
                : '<span class="text-muted">No enrollments</span>';
            document.getElementById('modalCourses').innerHTML = coursesHtml;

            new bootstrap.Modal(document.getElementById('studentModal')).show();
        }

        async function toggleStudentStatus() {
            if (!currentStudentId) return;
            const student = allStudents.find(s => s.id === currentStudentId);
            if (!student) return;

            const isActive = student.active !== false;
            const action = isActive ? 'deactivate' : 'activate';

            if (!confirm(`Are you sure you want to ${action} this student account?`)) return;

            try {
                await FirestoreDB.updateStudent(currentStudentId, { active: !isActive });
                showToast(`Student account ${action}d successfully`, 'success');
                await loadData();
                viewStudent(currentStudentId);
            } catch (e) {
                console.error(e);
                showToast(`Failed to ${action} account`, 'error');
            }
        }

        async function resetStudentPassword() {
            if (!currentStudentId) return;
            const student = allStudents.find(s => s.id === currentStudentId);
            if (!student) return;

            const newPassword = prompt('Enter new password for ' + student.email + ':');
            if (!newPassword || newPassword.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            if (!confirm('Are you sure you want to reset this student\'s password?')) return;

            try {
                await FirestoreDB.updateStudent(currentStudentId, { password: newPassword });
                showToast('Password reset successfully', 'success');
            } catch (e) {
                console.error(e);
                showToast('Failed to reset password', 'error');
            }
        }

        async function deleteStudent() {
            if (!currentStudentId) return;
            const student = allStudents.find(s => s.id === currentStudentId);
            if (!student) return;

            if (!confirm(`Are you sure you want to DELETE ${student.name}'s account? This action cannot be undone!`)) return;
            if (!confirm('This will also delete all enrollments and progress. Are you absolutely sure?')) return;

            try {
                await FirestoreDB.deleteStudent(currentStudentId);
                showToast('Student account deleted successfully', 'success');
                bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
                await loadData();
            } catch (e) {
                console.error(e);
                showToast('Failed to delete account', 'error');
            }
        }

        function exportToCSV() {
            if (allStudents.length === 0) {
                showToast('No data to export', 'info');
                return;
            }

            const headers = ['Name', 'Email', 'Signup Date', 'Enrollments'];
            const rows = allStudents.map(student => {
                const enrollmentCount = allEnrollments.filter(e => e.userId === student.id).length;
                const signupDate = student.createdAt?.toDate ? student.createdAt.toDate().toLocaleDateString() : '';
                return [
                    student.name || '',
                    student.email || '',
                    signupDate,
                    enrollmentCount
                ];
            });

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `students_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported successfully', 'success');
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allStudents.filter(s =>
                (s.name || '').toLowerCase().includes(query) ||
                (s.email || '').toLowerCase().includes(query)
            );
            renderStudents(filtered);
        });

        // Sidebar
        function setupSidebar() {
            const toggle = document.getElementById('sidebarToggle');
            const overlay = document.getElementById('sidebarOverlay');
            const sidebar = document.getElementById('sidebar');
            const closeBtn = document.getElementById('sidebarCloseBtn');

            toggle?.addEventListener('click', () => {
                sidebar.classList.add('show');
                overlay.classList.add('show');
            });

            overlay?.addEventListener('click', () => {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            });

            closeBtn?.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                document.getElementById('mainContent').classList.toggle('sidebar-collapsed');
            });
        }

        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            Auth.logout();
        });

        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
        function showToast(msg, type = 'info') {
            const c = document.getElementById('toastContainer');
            const icons = { success: 'bi-check-circle-fill', error: 'bi-x-circle-fill', info: 'bi-info-circle-fill' };
            const t = document.createElement('div'); t.className = `toast-item ${type}`;
            t.innerHTML = `<i class="bi ${icons[type]} toast-icon"></i><span class="toast-msg">${msg}</span><button class="toast-close" onclick="this.parentElement.remove()"><i class="bi bi-x-lg"></i></button>`;
            c.appendChild(t); setTimeout(() => t.remove(), 3500);
        }
    </script>
</body>

</html>