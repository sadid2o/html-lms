<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eduvance — Online Learning Platform</title>
    <meta name="description"
        content="Eduvance — Master new skills with professional video courses, PDFs, and resources.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body>

    <!-- Toast -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Announcement Banner -->
    <div class="announcement-banner" id="announcementBanner" style="display:none; margin-top:68px;">
        <i class="bi bi-megaphone-fill megaphone"></i>
        <span id="announcementText"></span>
        <button class="ann-close" onclick="document.getElementById('announcementBanner').style.display='none'">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>

    <!-- ===== NAVBAR ===== -->
    <nav class="navbar-edu" id="navbar">
        <a href="index.html" class="navbar-brand">
            <div class="logo-icon"><i class="bi bi-mortarboard-fill"></i></div>
            <span>Eduvance</span>
        </a>

        <div class="navbar-search" id="searchArea">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="searchInput" placeholder="Search courses..." oninput="handleSearch(this.value)">
        </div>

        <div class="navbar-actions" id="navActions">
            <!-- Filled by JS -->
        </div>

        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
            <i class="bi bi-moon-fill" id="themeIcon"></i>
        </button>

        <button class="mobile-menu-btn" onclick="openMobileMenu()">
            <i class="bi bi-list"></i>
        </button>
    </nav>

    <!-- Mobile Drawer -->
    <div class="mobile-drawer-overlay" id="mobileOverlay" onclick="closeMobileMenu()"></div>
    <div class="mobile-drawer" id="mobileDrawer">
        <button class="mobile-drawer-close" onclick="closeMobileMenu()"><i class="bi bi-x-lg"></i></button>
        <ul class="mobile-nav-links" id="mobileNavLinks">
            <li><a href="index.html"><i class="bi bi-house"></i> Home</a></li>
            <li><a href="#courses" onclick="closeMobileMenu()"><i class="bi bi-collection-play"></i> Courses</a></li>
            <li><a href="#categoriesSection" onclick="closeMobileMenu()"><i class="bi bi-grid-3x3-gap"></i>
                    Categories</a></li>
            <div class="mobile-drawer-divider"></div>
            <li id="mobileAuthLinks"><!-- Filled by JS --></li>
        </ul>
        <div class="mobile-drawer-divider"></div>
        <div style="padding:8px 14px;">
            <button class="theme-toggle" onclick="toggleTheme()"
                style="width:100%; justify-content:flex-start; gap:10px; padding:10px 14px; border-radius:10px;">
                <i class="bi bi-moon-fill" id="themeIconMobile"></i>
                <span style="font-size:0.88rem; font-weight:500;" id="themeTextMobile">Dark Mode</span>
            </button>
        </div>
    </div>

    <!-- Announcement Banner -->
    <div class="announcement-banner" id="announcementBanner" style="display:none;">
        <div class="announcement-content">
            <i class="bi bi-megaphone-fill"></i>
            <span id="announcementText"></span>
        </div>
        <button class="announcement-close" onclick="closeAnnouncement()">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>

    <!-- ===== HERO ===== -->
    <section class="hero-section">
        <div class="hero-content animate-up">
            <h1>Master New Skills, Anytime, Anywhere</h1>
            <p>Access professional video courses, PDFs, and downloadable resources. Learn at your own pace with
                Eduvance.</p>
            <div class="hero-cta">
                <a href="#courses" class="btn-primary-custom"><i class="bi bi-play-circle"></i> Browse Courses</a>
                <a href="signup.html" class="btn-outline-edu" id="heroSignupBtn"><i class="bi bi-person-plus"></i> Get
                    Started</a>
            </div>
        </div>
    </section>

    <!-- ===== CONTINUE WATCHING ===== -->
    <section class="continue-watching-section" id="continueWatchingSection" style="display:none;">
        <h2><i class="bi bi-arrow-counterclockwise"></i> Continue Watching</h2>
        <div class="cw-grid" id="cwGrid"></div>
    </section>

    <!-- ===== CATEGORIES ===== -->
    <section class="categories-section container-edu" id="categoriesSection">
        <div class="section-title"><i class="bi bi-grid-3x3-gap"></i> Categories</div>
        <div class="category-chips" id="categoryChips">
            <div class="category-chip active" data-category="all" onclick="filterByCategory('all')">All Courses</div>
        </div>
    </section>

    <!-- ===== COURSES ===== -->
    <section class="courses-section container-edu" id="courses">
        <div class="section-title"><i class="bi bi-book-half"></i> Courses</div>

        <!-- Filters Bar -->
        <div class="filters-bar">
            <select class="filter-select" id="sortFilter" onchange="applyFilters()">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="az">A → Z</option>
                <option value="za">Z → A</option>
            </select>
            <select class="filter-select" id="categoryFilter" onchange="filterByCategorySelect(this.value)">
                <option value="all">All Categories</option>
                <!-- Filled by JS -->
            </select>
            <span class="filter-results-count" id="resultsCount"></span>
        </div>

        <div class="course-grid" id="courseGrid">
            <!-- Skeleton cards while loading -->
            <div class="skeleton-card">
                <div class="skeleton-thumb skeleton-pulse"></div>
                <div class="skeleton-body">
                    <div class="skeleton-line skeleton-pulse w-40"></div>
                    <div class="skeleton-line skeleton-pulse h-20 w-80"></div>
                    <div class="skeleton-line skeleton-pulse w-60"></div>
                </div>
            </div>
            <div class="skeleton-card">
                <div class="skeleton-thumb skeleton-pulse"></div>
                <div class="skeleton-body">
                    <div class="skeleton-line skeleton-pulse w-40"></div>
                    <div class="skeleton-line skeleton-pulse h-20 w-80"></div>
                    <div class="skeleton-line skeleton-pulse w-60"></div>
                </div>
            </div>
            <div class="skeleton-card">
                <div class="skeleton-thumb skeleton-pulse"></div>
                <div class="skeleton-body">
                    <div class="skeleton-line skeleton-pulse w-40"></div>
                    <div class="skeleton-line skeleton-pulse h-20 w-80"></div>
                    <div class="skeleton-line skeleton-pulse w-60"></div>
                </div>
            </div>
        </div>
        <div class="load-more-area" id="loadMoreArea" style="display:none;">
            <button class="btn-primary-custom" id="loadMoreBtn" onclick="loadMoreCourses()">
                <i class="bi bi-arrow-down-circle"></i> Load More
            </button>
        </div>
        <div id="noCoursesMsg" style="display:none; text-align:center; padding:60px 20px; color:var(--text-muted);">
            <i class="bi bi-inbox" style="font-size:3rem; display:block; margin-bottom:12px; opacity:0.4;"></i>
            <p>No courses found</p>
        </div>
    </section>

    <!-- ===== FOOTER CTA ===== -->
    <section class="footer-cta">
        <div class="footer-cta-inner">
            <h3>Start Your Learning Journey Today</h3>
            <p>Join thousands of students and gain access to professional courses, expert-led video lectures, and
                downloadable resources.</p>
            <div class="cta-btns">
                <a href="signup.html" class="btn-primary-custom"><i class="bi bi-rocket-takeoff"></i> Get Started
                    Free</a>
                <a href="#courses" class="btn-outline-edu"><i class="bi bi-collection-play"></i> Browse Courses</a>
            </div>
        </div>
    </section>

    <!-- ===== FOOTER FEATURES ===== -->
    <section class="footer-features">
        <div class="footer-features-inner">
            <div class="footer-feature">
                <div class="footer-feature-icon purple"><i class="bi bi-play-circle-fill"></i></div>
                <div class="footer-feature-text">
                    <h6>Video Lectures</h6>
                    <p>HD quality video lessons with subtitle support</p>
                </div>
            </div>
            <div class="footer-feature">
                <div class="footer-feature-icon teal"><i class="bi bi-infinity"></i></div>
                <div class="footer-feature-text">
                    <h6>Lifetime Access</h6>
                    <p>Learn anytime, anywhere at your own pace</p>
                </div>
            </div>
            <div class="footer-feature">
                <div class="footer-feature-icon orange"><i class="bi bi-file-earmark-pdf-fill"></i></div>
                <div class="footer-feature-text">
                    <h6>PDF Resources</h6>
                    <p>Downloadable study materials and notes</p>
                </div>
            </div>
            <div class="footer-feature">
                <div class="footer-feature-icon green"><i class="bi bi-shield-check"></i></div>
                <div class="footer-feature-text">
                    <h6>Secure Platform</h6>
                    <p>Your data and progress are always safe</p>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== FOOTER ===== -->
    <footer class="footer-edu">
        <div class="footer-content">
            <div class="footer-brand">
                <a href="index.html" class="navbar-brand">
                    <div class="logo-icon"><i class="bi bi-mortarboard-fill"></i></div>
                    <span>Eduvance</span>
                </a>
                <p>Empowering learners with professional-grade courses and resources.</p>
                <div class="footer-socials">
                    <a href="#" class="footer-social-icon" title="Facebook"><i class="bi bi-facebook"></i></a>
                    <a href="#" class="footer-social-icon" title="YouTube"><i class="bi bi-youtube"></i></a>
                    <a href="#" class="footer-social-icon" title="Instagram"><i class="bi bi-instagram"></i></a>
                    <a href="#" class="footer-social-icon" title="Twitter"><i class="bi bi-twitter-x"></i></a>
                </div>
            </div>
            <div class="footer-links">
                <h6>Platform</h6>
                <a href="index.html"><i class="bi bi-chevron-right"></i> Home</a>
                <a href="#courses"><i class="bi bi-chevron-right"></i> All Courses</a>
                <a href="signup.html"><i class="bi bi-chevron-right"></i> Sign Up</a>
                <a href="login.html"><i class="bi bi-chevron-right"></i> Login</a>
            </div>
            <div class="footer-links">
                <h6>Resources</h6>
                <a href="#"><i class="bi bi-chevron-right"></i> Video Tutorials</a>
                <a href="#"><i class="bi bi-chevron-right"></i> PDF Materials</a>
                <a href="#"><i class="bi bi-chevron-right"></i> FAQs</a>
            </div>
            <div class="footer-links">
                <h6>Company</h6>
                <a href="#"><i class="bi bi-chevron-right"></i> About Eduvance</a>
                <a href="#"><i class="bi bi-chevron-right"></i> Contact Us</a>
                <a href="#"><i class="bi bi-chevron-right"></i> Blog</a>
            </div>
        </div>
        <div class="footer-bottom">
            <span>&copy; 2025 Eduvance. All rights reserved.</span>
            <div class="footer-bottom-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // ---- State ----
        let allCourses = [];
        let filteredCourses = [];
        let categories = [];
        let currentCategory = 'all';
        let coursesPerPage = 6;
        let currentPage = 1;
        let categoryMap = {};
        let currentSort = 'newest';

        // ---- Theme ----
        function initTheme() {
            const saved = localStorage.getItem('eduvance-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            updateThemeIcons(saved);
        }
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('eduvance-theme', next);
            updateThemeIcons(next);
        }
        function updateThemeIcons(theme) {
            const icon = theme === 'light' ? 'bi-sun-fill' : 'bi-moon-fill';
            const el = document.getElementById('themeIcon');
            const elM = document.getElementById('themeIconMobile');
            const txtM = document.getElementById('themeTextMobile');
            if (el) el.className = 'bi ' + icon;
            if (elM) elM.className = 'bi ' + icon;
            if (txtM) txtM.textContent = theme === 'light' ? 'Light Mode' : 'Dark Mode';
        }
        initTheme();

        // ---- Mobile Menu ----
        function openMobileMenu() {
            document.getElementById('mobileOverlay').classList.add('show');
            document.getElementById('mobileDrawer').classList.add('show');
        }
        function closeMobileMenu() {
            document.getElementById('mobileOverlay').classList.remove('show');
            document.getElementById('mobileDrawer').classList.remove('show');
        }

        // ---- Init ----
        document.addEventListener('DOMContentLoaded', async () => {
            updateNavAuth();
            await loadData();
            loadAnnouncements();
            loadContinueWatching();
        });

        function updateNavAuth() {
            const nav = document.getElementById('navActions');
            const mobileAuth = document.getElementById('mobileAuthLinks');
            const user = UserAuth.isLoggedIn() ? UserAuth.getUser() : null;
            if (user) {
                nav.innerHTML = `
          <div class="user-menu" onclick="toggleUserDropdown()">
            <div class="user-avatar-sm"><i class="bi bi-person-fill"></i></div>
            <span class="user-name-sm">${escapeHTML(user.name)}</span>
            <i class="bi bi-chevron-down" style="font-size:0.7rem; color:var(--text-muted)"></i>
          </div>
          <div id="userDropdown" style="display:none; position:absolute; top:60px; right:24px; background:var(--bg-card); border:1px solid var(--border-color); border-radius:10px; padding:8px; min-width:160px; box-shadow:var(--shadow-lg); z-index:1001;">
            <a href="#" onclick="UserAuth.logout(); return false;" style="display:flex; align-items:center; gap:8px; padding:10px 14px; border-radius:8px; font-size:0.85rem; color:var(--text-secondary); transition:0.2s ease;">
              <i class="bi bi-box-arrow-left"></i> Logout
            </a>
          </div>
        `;
                document.getElementById('heroSignupBtn').style.display = 'none';
                mobileAuth.innerHTML = `
                    <a href="#" onclick="UserAuth.logout();closeMobileMenu();return false;"><i class="bi bi-box-arrow-left"></i> Logout (${escapeHTML(user.name)})</a>
                `;
            } else {
                nav.innerHTML = `
          <a href="login.html" class="btn-login"><i class="bi bi-box-arrow-in-right"></i> <span>Login</span></a>
          <a href="signup.html" class="btn-signup"><i class="bi bi-person-plus"></i> <span>Sign Up</span></a>
        `;
                mobileAuth.innerHTML = `
                    <a href="login.html"><i class="bi bi-box-arrow-in-right"></i> Login</a>
                    <a href="signup.html"><i class="bi bi-person-plus"></i> Sign Up</a>
                `;
            }
        }

        function toggleUserDropdown() {
            const dd = document.getElementById('userDropdown');
            dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
        }
        document.addEventListener('click', (e) => {
            const dd = document.getElementById('userDropdown');
            if (dd && !e.target.closest('.user-menu')) dd.style.display = 'none';
        });

        // ---- Announcements ----
        async function loadAnnouncements() {
            try {
                const anns = await DB.getActiveAnnouncements();
                if (anns.length > 0) {
                    document.getElementById('announcementText').textContent = anns[0].message || anns[0].title;
                    document.getElementById('announcementBanner').style.display = 'flex';
                }
            } catch (e) { /* silent */ }
        }

        // ---- Continue Watching ----
        async function loadContinueWatching() {
            const user = UserAuth.isLoggedIn() ? UserAuth.getUser() : null;
            if (!user) return;
            try {
                const recent = await DB.getRecentlyWatched(user.id, 6);
                if (recent.length === 0) return;

                const grid = document.getElementById('cwGrid');
                let html = '';
                const seen = new Set();
                for (const p of recent) {
                    if (seen.has(p.contentId)) continue;
                    seen.add(p.contentId);
                    const course = await DB.getCourse(p.courseId);
                    const content = await DB.getContent(p.courseId, p.sectionId, p.contentId);
                    if (!course || !content) continue;

                    const pct = p.duration ? Math.round((p.watchedSeconds / p.duration) * 100) : 0;
                    const thumb = course.thumbnail || '';
                    html += `
                    <div class="cw-card" onclick="window.location.href='player.html?courseId=${p.courseId}&sectionId=${p.sectionId}&contentId=${p.contentId}'">
                        <div class="cw-thumb">
                            ${thumb ? `<img src="${escapeAttr(thumb)}" alt="">` : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;"><i class="bi bi-play-circle" style="font-size:2rem;color:var(--text-muted);"></i></div>`}
                            <div class="cw-progress-bar"><div class="fill" style="width:${pct}%"></div></div>
                        </div>
                        <div class="cw-info">
                            <h6>${escapeHTML(content.name || 'Untitled')}</h6>
                            <p>${escapeHTML(course.name || '')} · ${pct}% watched</p>
                        </div>
                    </div>`;
                }
                if (html) {
                    grid.innerHTML = html;
                    document.getElementById('continueWatchingSection').style.display = 'block';
                }
            } catch (e) { console.error(e); }
        }

        // ---- Load Data ----
        async function loadData() {
            try {
                [categories, allCourses] = await Promise.all([DB.getAllCategories(), DB.getAllCourses()]);
                categoryMap = {};
                categories.forEach(c => categoryMap[c.id] = c.name);
                renderCategories();
                populateCategoryFilter();
                filterByCategory('all');
            } catch (e) { console.error('Load data error:', e); }
        }

        function renderCategories() {
            const container = document.getElementById('categoryChips');
            const chipsHTML = categories.map(cat =>
                `<div class="category-chip" data-category="${cat.id}" onclick="filterByCategory('${cat.id}')">${escapeHTML(cat.name)}</div>`
            ).join('');
            container.innerHTML = `<div class="category-chip active" data-category="all" onclick="filterByCategory('all')">All Courses</div>` + chipsHTML;
        }

        function populateCategoryFilter() {
            const sel = document.getElementById('categoryFilter');
            sel.innerHTML = '<option value="all">All Categories</option>' +
                categories.map(c => `<option value="${c.id}">${escapeHTML(c.name)}</option>`).join('');
        }

        function filterByCategory(catId) {
            currentCategory = catId;
            currentPage = 1;
            document.querySelectorAll('.category-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.category === catId);
            });
            // Sync dropdown
            document.getElementById('categoryFilter').value = catId;
            applyFilters();
        }

        function filterByCategorySelect(catId) {
            currentCategory = catId;
            currentPage = 1;
            document.querySelectorAll('.category-chip').forEach(c => {
                c.classList.toggle('active', c.dataset.category === catId);
            });
            applyFilters();
        }

        function handleSearch(query) {
            currentPage = 1;
            applyFilters();
        }

        function applyFilters() {
            const query = (document.getElementById('searchInput').value || '').toLowerCase().trim();
            currentSort = document.getElementById('sortFilter').value;

            // Category filter
            if (currentCategory === 'all') {
                filteredCourses = [...allCourses];
            } else {
                filteredCourses = allCourses.filter(c => c.categoryId === currentCategory);
            }

            // Search filter
            if (query) {
                filteredCourses = filteredCourses.filter(c =>
                    (c.name || '').toLowerCase().includes(query) ||
                    (c.description || '').toLowerCase().includes(query) ||
                    (categoryMap[c.categoryId] || '').toLowerCase().includes(query)
                );
            }

            // Sort
            filteredCourses.sort((a, b) => {
                switch (currentSort) {
                    case 'oldest':
                        return (toMs(a.createdAt)) - (toMs(b.createdAt));
                    case 'az':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'za':
                        return (b.name || '').localeCompare(a.name || '');
                    default: // newest
                        return (toMs(b.createdAt)) - (toMs(a.createdAt));
                }
            });

            renderCourses();
        }

        function toMs(ts) {
            if (!ts) return 0;
            if (ts.toDate) return ts.toDate().getTime();
            return new Date(ts).getTime();
        }

        function renderCourses() {
            const grid = document.getElementById('courseGrid');
            const noMsg = document.getElementById('noCoursesMsg');
            const loadArea = document.getElementById('loadMoreArea');
            const visible = filteredCourses.slice(0, currentPage * coursesPerPage);

            // Update results count
            document.getElementById('resultsCount').textContent = `${filteredCourses.length} course${filteredCourses.length !== 1 ? 's' : ''} found`;

            if (filteredCourses.length === 0) {
                grid.innerHTML = '';
                noMsg.style.display = 'block';
                loadArea.style.display = 'none';
                return;
            }
            noMsg.style.display = 'none';

            grid.innerHTML = visible.map((course, i) => {
                const catName = categoryMap[course.categoryId] || '';
                const thumb = course.thumbnail
                    ? `<img src="${escapeAttr(course.thumbnail)}" alt="${escapeAttr(course.name)}" loading="lazy">`
                    : `<i class="bi bi-book-half thumb-placeholder"></i>`;
                return `
          <div class="course-card animate-up delay-${(i % 4) + 1}" onclick="window.location.href='course.html?id=${course.id}'">
            <div class="course-card-thumb">${thumb}</div>
            <div class="course-card-body">
              ${catName ? `<div class="course-card-category">${escapeHTML(catName)}</div>` : ''}
              <div class="course-card-title">${escapeHTML(course.name || 'Untitled')}</div>
              <div class="course-card-meta">
                <span><i class="bi bi-calendar3"></i> ${formatDate(course.createdAt)}</span>
              </div>
            </div>
          </div>
        `;
            }).join('');

            loadArea.style.display = visible.length < filteredCourses.length ? 'block' : 'none';
        }

        function loadMoreCourses() {
            currentPage++;
            renderCourses();
        }

        // ---- Announcements ----
        async function loadAnnouncements() {
            try {
                const announcements = await DB.getActiveAnnouncements();
                if (announcements.length > 0) {
                    const latest = announcements[0];
                    document.getElementById('announcementText').textContent = latest.title + ': ' + latest.message;
                    document.getElementById('announcementBanner').style.display = 'flex';
                }
            } catch (e) {
                console.error('Failed to load announcements:', e);
            }
        }

        function closeAnnouncement() {
            document.getElementById('announcementBanner').style.display = 'none';
        }

        // ---- Helpers ----
        function escapeHTML(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
        function escapeAttr(s) { return (s || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
        function formatDate(ts) {
            if (!ts) return '';
            const d = ts.toDate ? ts.toDate() : new Date(ts);
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Load announcements on page load
        loadAnnouncements();
    </script>
</body>

</html>